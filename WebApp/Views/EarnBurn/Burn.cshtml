
@{
    ViewBag.Title = "Burn";
    Layout = "~/Views/Shared/_LayoutITOPS.cshtml";
}

<div class="app-main__inner">
    <div class="mb-3 card" style="padding-top:20px;">
        <div class="content">
            <div class="container overflow-hidden">

                <div class="multisteps-form__panel shadow p-4 list-box bg-white" id="sec4" data-animation="scaleIn">
                    <h4 class="multisteps-form__title" style="color:blue;">Redeem / Deduct</h4><br />
                    <div class="multisteps-form__content">
                        <div>
                            <meta name="viewport" content="width=devicewidth, initial-scaled=1.0">
                            <label style="padding-right:5px;padding-top:10px;">Enter Mobile Number </label>
                            <input type="number" id="txtMobileNo3" class="input50" />

                            <label style="padding-right:30px;padding-top:10px;padding-left:30px;"><b>(OR)</b> </label>

                            <label style="padding-right:5px;padding-top:10px;">Enter Card Number </label>
                            <input type="number" id="txtCardNo3" class="input50" />
                            <button type="button" id="btnSearchMember3" style="margin-left:15px;margin-top:10px;" class="btn btn-primary">Go</button>
                        </div>
                        <div>
                            <div style="margin-left:30px;margin-bottom:30px;margin-top:30px;">
                                <input type="radio" name="first_item3" id="rbtnSMS3" /> Send SMS
                                <input type="radio" name="first_item3" style="margin-left:30px;" checked id="rbtnNOSMS3" /> Don't Send SMS

                                <input type="radio" name="first_item9" style="margin-left:30px;" checked id="rbtnRedeem" /> Redeem
                                <input type="radio" name="first_item9" style="margin-left:30px;" id="rbtnDeduct" /> Deduct
                            </div>
                            <div style="display:flex; height:auto;">
                                <input type="hidden" id="hdnCustomerId3" />
                                <table border="2" cellpadding="5" cellspacing="5">
                                    <tr position: absolute top: -9999px; left: -9998px;>
                                        >
                                        <th colspan="2" style="padding:10px;text-align:center;">Existing Member Details</th>
                                    </tr>
                                    <tr border: 1px solid #ccc;>
                                        <td style="padding:10px;">Member Name</td>
                                        <td style="padding:10px;width:200px;"><span style="color:red;" id="spnMemberName3"></span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Mobile No</td>
                                        <td style="padding:10px;"><span id="spnMobileno3"></span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Card No</td>
                                        <td style="padding:10px;"><span id="spnCardNo3"></span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Points Balance</td>
                                        <td style="padding:10px;"><span id="spnPtBalance3"></span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Enrolled Outlet</td>
                                        <td style="padding:10px;"><span id="spnEnrolledOutlet3"></span></td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Enrolled On</td>
                                        <td style="padding:10px;"><span id="spnEnrolledOn3"></span></td>
                                    </tr>

                                </table>
                                <table border="2" cellpadding="5" cellspacing="5" id="tblUpdateData3" style="margin-left:50px;display:none;">
                                    <tr>
                                        <th colspan="2" style="padding:10px;text-align:center;">Points Earning on a Purchase Txn</th>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;width:200px;">Enter Invoice Number</td>
                                        <td style="padding:10px;width:200px;">
                                            <input type="text" id="txtInvoiceNumber1" placeholder="Invoice No" class="input50" />

                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;width:200px;">Enter Invoice Amount</td>
                                        <td style="padding:10px;width:200px;">
                                            <input type="number" id="txtInvoiceAmount1" placeholder="Invoice Amt" class="input50" />

                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;width:200px;">Enter Points to Redeem/Deduct</td>
                                        <td style="padding:10px;width:200px;">
                                            <input type="number" id="txtPointsToRedeem" placeholder="Enter Points" class="input50" />

                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;width:200px;">Select Outlet</td>
                                        <td style="padding:10px;width:200px;">
                                            @Html.DropDownList("Outlet", new SelectList(ViewBag.OutletList, "Value", "Text"), "Select Outlet", htmlAttributes: new { @class = "input50", @id = "ddlOutletList1" })

                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Requested by</td>
                                        <td style="padding:10px;">
                                            <input type="text" id="txtRequestedByName3" placeholder="Requested By" class="input50" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Requested on Forum</td>
                                        <td style="padding:10px;">
                                            <select name="ddlRequestedForum3" id="ddlRequestedForum3" class="input50">
                                                <option value="Whatsapp">Whatsapp</option>
                                                <option value="Email">Email</option>
                                                <option value="Phone">Phone</option>
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:10px;">Transaction Date</td>
                                        <td style="padding:10px;"><input type="text" id="dtTransaction1" class="input50" /></td>
                                    </tr>
                                </table>


                            </div>
                        </div>
                    </div>
                    <div class="button-row d-flex mt-5">
                        <button class="btn btn-primary ml-auto" type="button" title="Next" id="btnSaveRedeem" tabindex="20">Save</button>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/Content/scriptSteps.js"></script>

<script>
       $("#hdnGroupId").val(@Html.Raw(ViewBag.GroupId));

     $(document).ready(function () {
     var today = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
       // alert(today);

        $('#btnSearchMember3').on("click", function () {
        GetRedeemData();
        });

        $("#dtTransaction1").datepicker({

        dateFormat: "yy-mm-dd",
        maxDate: today,
         // minDate: '-4'
        });

        $('#btnSaveRedeem').on("click", function () {
        SaveRedeemData();
        });
         $('#btnredeeem').on("click", function () {
             GetClearAllTab();
         });
     });


   function GetRedeemData() {
        if ($('#txtMobileNo3').val() == "" && $('#txtCardNo3').val() == "") {
            toastr.error('Please enter Mobile Number OR Card Number');
            return false
        }
        if ($('#txtMobileNo3').val() != "" && $('#txtCardNo3').val() != "") {
            toastr.error('Please enter Mobile Number OR Card Number');
            return false
        }
        $("#divLoader").show();
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetChangeNameData", "EarnBurn")',//"/ITOperations/GetChangeNameData",
            data: '{ MobileNo: ' + JSON.stringify($('#txtMobileNo3').val()) + ',CardNo: ' + JSON.stringify($('#txtCardNo3').val()) + '}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (result) {
            if (result.MemberName != null) {
            $("#spnMemberName3").text(result.MemberName);
            $("#spnMobileno3").text(result.MobileNo);
            $("#spnCardNo3").text(result.CardNo);
            $("#spnPtBalance3").text(result.PointsBalance);
            $("#spnEnrolledOutlet3").text(result.EnrolledOutletName);
            $("#spnEnrolledOn3").text(result.EnrolledOn);
            $("#hdnCustomerId3").val(result.CustomerId);

            $('#txtInvoiceNumber1').val("");
            $('#txtInvoiceAmount1').val("");
            $('#txtPointsToRedeem').val("");
            $('#txtRequestedByName3').val("");
            $('#dtTransaction1').val("");

            $('#ddlOutletList1').prop('selectedIndex', 0);
            $('#ddlRequestedForum3').prop('selectedIndex', 0);
            $("#tblUpdateData3").show();
            }
            else {
            toastr.error('Member not present. Please check entered Mobile Number OR Card Number');
            $("#spnMemberName3").text("");
            $("#spnMobileno3").text("");
            $("#spnCardNo3").text("");
            $("#spnPtBalance3").text("");
            $("#spnEnrolledOutlet3").text("");
            $("#spnEnrolledOn3").text("");
            $("#hdnCustomerId3").val("");

            $('#txtInvoiceNumber1').val("");
            $('#txtInvoiceAmount1').val("");
            $('#txtPointsToRedeem').val("");
            $('#txtRequestedByName3').val("");
            $('#dtTransaction1').val("");
            $('#ddlRequestedForum3').prop('selectedIndex', 0);
            $('#ddlOutletList1').prop('selectedIndex', 0);
            $("#tblUpdateData3").hide();
            }
            $("#divLoader").hide();
            },
            error: function (result) {
            console.log(result.responseText)
            $("#divLoader").hide();
            }
        });
    }

    function SaveRedeemData() {

        if (parseFloat($("#txtPointsToRedeem").val()) > parseFloat($("#spnPtBalance3").text())) {
            toastr.error('Redeem points can not be greater than available points');
            $('#txtPointsToRedeem').focus();
            return false;
        }

        if ($('#txtInvoiceNumber1').val() == "") {
            toastr.error('Please enter Invoice Number');
            $('#txtInvoiceNumber1').focus();
            return false;
        }
        if ($('#txtInvoiceAmount1').val() == "") {
            toastr.error('Please enter Invoice Amount');
            $('#txtInvoiceAmount1').focus();
            return false;
        }
        if ($('#txtPointsToRedeem').val() == "") {
            toastr.error('Please enter Points to Redeem');
            $('#txtPointsToRedeem').focus();
            return false;
        }
        if ($('#ddlOutletList1').val() == "") {
            toastr.error('Please select Outlet');
            $('#ddlOutletList1').focus();
            return false;
        }
        if ($('#txtRequestedByName3').val() == "") {
            toastr.error('Please enter Requested Person name');
            $('#txtRequestedByName3').focus();
            return false;
        }
        if ($('#dtTransaction1').val() == "") {
            toastr.error('Please select Transaction date');
            $('#dtTransaction1').focus();
            return false;
        }

        if (confirm("Are you sure? You want to Redeem/Deduct Points")) {
            var MemberData = [];
            item = {}
            item["GroupID"] = $("#hdnGroupId").val();
            item["MobileNo"] = $("#txtMobileNo3").val();
            item["OutletId"] = $("#ddlOutletList1").val();
            item["RedeemPoints"] = $("#txtPointsToRedeem").val();
            item["TransactionDate"] = $("#dtTransaction1").val();
            item["InvoiceNumber"] = $("#txtInvoiceNumber1").val();
            item["InvoiceAmount"] = $("#txtInvoiceAmount1").val();
            item["RequestedBy"] = $("#txtRequestedByName3").val();
            item["RequestedForum"] = $('#ddlRequestedForum3 :selected').text();
            item["RequestedOn"] = $("#dtTransaction1").val();

            if ($('#rbtnSMS3').is(":checked")) {
                item["IsSMS"] = 1;
            }
            if ($('#rbtnNOSMS3').is(":checked")) {
                item["IsSMS"] = 0;
            }
            if ($('#rbtnDeduct').is(":checked")) {
                item["TxnType"] = 1;
            }
            if ($('#rbtnRedeem').is(":checked")) {
                item["TxnType"] = 0;
            }
            MemberData.push(item);
            var data = JSON.stringify(MemberData);
            console.log(data)
            $("#divLoader").show();
            $.ajax({
                type: "POST",
                url: '@Url.Action("RedeemPointsData", "EarnBurn")',//"/ITOperations/RedeemPointsData",
                data: '{jsonData: ' + JSON.stringify(data) + '}',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (result) {
                    if (result.ResponseCode == "00") {
                        toastr.success("Redeem/Deduct Successfully");
                        $("#divLoader").hide();
                        $('#sec4').find(':input').val('');
                    }
                    else {
                        toastr.error(result.ResponseMessage);
                        $("#divLoader").hide();
                    }
                },
                error: function (result) {
                    console.log(result.responseText)
                    if (result.responseText == "True") {
                        toastr.success("Data Updated Successfully");
                        $("#divLoader").hide();
                        $('#sec4').find(':input').val('');
                    }
                    else {
                        toastr.error('error occured while saving data');
                        $("#divLoader").hide();
                    }
                }
            });
        }
    }




</script>
<script src="~/Scripts/jquery-ui-1.12.1.js"></script>
<script src="~/Scripts/jquery-ui-1.12.1.min.js"></script>
<link href="~/Content/themes/base/jquery-ui.min.css" rel="stylesheet" />
<link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" />
